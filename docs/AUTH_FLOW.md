# qcarios è®¤è¯æµç¨‹æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ qcarios åº”ç”¨çš„å®Œæ•´è®¤è¯æµç¨‹ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„å®ç°æ–¹å¼ã€‚

---

## ğŸ¯ æ ‡å‡†è®¤è¯æµç¨‹ï¼ˆæ¨èï¼‰

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®Œæ•´è®¤è¯æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
     â”‚
     â–¼
â‘  å‘é€éªŒè¯ç 
     â”‚
     â”œâ”€ å¼€å‘ç¯å¢ƒ: æ¨¡æ‹Ÿå‘é€ï¼ˆå›ºå®šéªŒè¯ç  123456ï¼‰
     â””â”€ ç”Ÿäº§ç¯å¢ƒ: client.auth.signInWithOTP(phone)
     â”‚
     â–¼
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
     â”‚
     â–¼
â‘¡ éªŒè¯éªŒè¯ç 
     â”‚
     â”œâ”€ å¼€å‘ç¯å¢ƒ:
     â”‚   â”œâ”€ éªŒè¯å›ºå®šç  123456
     â”‚   â””â”€ ä½¿ç”¨é‚®ç®±æ¨¡æ‹Ÿ: client.auth.signUp/signIn(email)
     â”‚       â””â”€ è·å¾— auth.user.id
     â”‚
     â””â”€ ç”Ÿäº§ç¯å¢ƒ:
         â””â”€ client.auth.verifyOTP(phone, code)
             â””â”€ è·å¾— auth.user.id
     â”‚
     â–¼
â‘¢ åˆ›å»º/æŸ¥è¯¢ä¸šåŠ¡ç”¨æˆ·
     â”‚
     â”œâ”€ æŸ¥è¯¢ public.users WHERE id = auth.user.id
     â”‚   â””â”€ å­˜åœ¨ â†’ è¿”å›ç°æœ‰ç”¨æˆ· âœ…
     â”‚
     â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·
         â”œâ”€ INSERT INTO public.users (id, phone, role, ...)
         â”‚   VALUES (auth.user.id, ...)
         â”‚
         â””â”€ INSERT INTO passenger_profiles (user_id)
             VALUES (auth.user.id)
     â”‚
     â–¼
â‘£ ç™»å½•æˆåŠŸ
     â””â”€ è®¾ç½® currentUser
     â””â”€ è·³è½¬åˆ°è§’è‰²é€‰æ‹©/ä¸»é¡µ
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 1: å‘é€éªŒè¯ç 

**ç”¨æˆ·æ“ä½œ**: è¾“å…¥æ‰‹æœºå·ï¼ˆå¦‚ 13800138001ï¼‰

#### å¼€å‘ç¯å¢ƒ

```swift
// æ¨¡æ‹Ÿå‘é€ï¼Œä¸å®é™…è°ƒç”¨ API
print("ğŸ“± å‘é€éªŒè¯ç åˆ°: \(phone)")
print("ğŸ”¢ éªŒè¯ç : 123456 (å¼€å‘ç¯å¢ƒå›ºå®šéªŒè¯ç )")
```

**ç‰¹ç‚¹**:
- âœ… æ— éœ€é…ç½®çŸ­ä¿¡æœåŠ¡
- âœ… å¿«é€Ÿå¼€å‘æµ‹è¯•
- âœ… å›ºå®šéªŒè¯ç  `123456`

#### ç”Ÿäº§ç¯å¢ƒ

```swift
try await client.auth.signInWithOTP(phone: phone)
```

**æ•ˆæœ**:
- âœ… Supabase Auth å‘é€çœŸå®çŸ­ä¿¡
- âœ… ç”ŸæˆéšæœºéªŒè¯ç 
- âœ… éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆé€šå¸¸ 60 ç§’ï¼‰

---

### æ­¥éª¤ 2: éªŒè¯éªŒè¯ç 

**ç”¨æˆ·æ“ä½œ**: è¾“å…¥éªŒè¯ç  123456

#### å¼€å‘ç¯å¢ƒ

```swift
// 1. éªŒè¯å›ºå®šéªŒè¯ç 
if code != "123456" {
    throw AuthError.verificationFailed
}

// 2. ä½¿ç”¨é‚®ç®±æ¨¡æ‹Ÿæ‰‹æœºå·è®¤è¯
let testEmail = "\(phone)@dev.local"  // 13800138001@dev.local
let testPassword = "password_\(phone)" // password_13800138001

// 3. å°è¯•ç™»å½•æˆ–æ³¨å†Œ
do {
    let session = try await client.auth.signIn(email: testEmail, password: testPassword)
    authUserId = session.user.id  // è·å– auth.users.id
} catch {
    let session = try await client.auth.signUp(email: testEmail, password: testPassword)
    authUserId = session.user.id
}
```

**æµç¨‹**:
1. æ£€æŸ¥éªŒè¯ç æ˜¯å¦ä¸º `123456`
2. ä½¿ç”¨æ‰‹æœºå·ç”Ÿæˆé‚®ç®±è´¦å·ï¼ˆ`æ‰‹æœºå·@dev.local`ï¼‰
3. å°è¯•é‚®ç®±ç™»å½•
   - æˆåŠŸ â†’ è·å–ç°æœ‰çš„ `auth.user.id`
   - å¤±è´¥ â†’ æ³¨å†Œæ–°è´¦å·ï¼Œè·å–æ–°çš„ `auth.user.id`
4. **å…³é”®**ï¼šè·å¾—çš„ `authUserId` å°†ç”¨äºå…³è” `public.users`

**ä¸ºä»€ä¹ˆç”¨é‚®ç®±æ¨¡æ‹Ÿï¼Ÿ**
- âœ… æœ¬åœ° Supabase ä¸éœ€è¦é…ç½®çŸ­ä¿¡æœåŠ¡
- âœ… å®Œå…¨æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„è®¤è¯æµç¨‹
- âœ… åˆ›å»ºçœŸå®çš„ `auth.users` è®°å½•
- âœ… è·å¾—çœŸå®çš„ Auth Session

#### ç”Ÿäº§ç¯å¢ƒ

```swift
let session = try await client.auth.verifyOTP(
    phone: phone,
    token: code,
    type: .sms
)
authUserId = session.user.id
```

**æ•ˆæœ**:
- âœ… éªŒè¯çœŸå®çš„çŸ­ä¿¡éªŒè¯ç 
- âœ… è‡ªåŠ¨åˆ›å»º `auth.users` è®°å½•
- âœ… è¿”å› Auth Sessionï¼ˆåŒ…å« JWT tokenï¼‰
- âœ… è·å¾— `auth.user.id`

---

### æ­¥éª¤ 3: åˆ›å»º/æŸ¥è¯¢ä¸šåŠ¡ç”¨æˆ·

**å…³é”®ç‚¹**ï¼šä½¿ç”¨ `auth.user.id` ä½œä¸º `public.users.id`

```swift
private func signInOrRegister(phone: String, authUserId: UUID) async throws -> User {
    // 1. æŸ¥è¯¢æ˜¯å¦å­˜åœ¨
    if let existingUser = try await userRepository.getUserByPhone(phone: phone) {
        return existingUser  // å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    }

    // 2. ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
    let newUserData = [
        "id": authUserId.uuidString,  // â­ ä½¿ç”¨ auth.user.id
        "phone": phone,
        "role": "passenger",
        "is_verified": false,
        "status": "active"
    ]

    // 3. æ’å…¥ public.users
    let user = try await insertUser(newUserData)

    // 4. åˆ›å»º passenger_profiles
    let profileData = ["user_id": authUserId.uuidString]
    try await insertPassengerProfile(profileData)

    return user
}
```

**æ•°æ®å…³ç³»**:
```
auth.users.id = "550e8400-..." (ç”± Supabase Auth ç”Ÿæˆ)
     â†“
public.users.id = "550e8400-..." (ä½¿ç”¨ç›¸åŒ ID)
     â†“
passenger_profiles.user_id = "550e8400-..." (å¤–é”®å…³è”)
```

---

### æ­¥éª¤ 4: ç™»å½•æˆåŠŸ

```swift
self.currentUser = user
return user
```

**æ•ˆæœ**:
- âœ… `AuthService.currentUser` è¢«è®¾ç½®
- âœ… `isAuthenticated` è¿”å› `true`
- âœ… å‘å¸ƒè®¤è¯çŠ¶æ€å˜åŒ–é€šçŸ¥
- âœ… ç•Œé¢è‡ªåŠ¨è·³è½¬

---

## ğŸ”„ å®Œæ•´ä»£ç æµç¨‹

### ç”¨æˆ·é¦–æ¬¡ç™»å½•ï¼ˆæ–°ç”¨æˆ·ï¼‰

```
è¾“å…¥æ‰‹æœºå·: 13800138001
     â†“
ç‚¹å‡»"è·å–éªŒè¯ç "
     â†“
[å¼€å‘ç¯å¢ƒ]
æ¨¡æ‹Ÿå‘é€éªŒè¯ç ï¼ˆæ— å®é™…æ“ä½œï¼‰
     â†“
è¾“å…¥éªŒè¯ç : 123456
     â†“
ç‚¹å‡»"ç™»å½•"
     â†“
éªŒè¯éªŒè¯ç  âœ…
     â†“
åˆ›å»º auth.users (é€šè¿‡é‚®ç®±æ³¨å†Œ)
â”œâ”€ email: 13800138001@dev.local
â”œâ”€ password: password_13800138001
â””â”€ id: 550e8400-e29b-41d4-a716-446655440000
     â†“
æŸ¥è¯¢ public.users (ä¸å­˜åœ¨)
     â†“
åˆ›å»º public.users
â”œâ”€ id: 550e8400-... (ç›¸åŒID)
â”œâ”€ phone: 13800138001
â”œâ”€ role: passenger
â””â”€ status: active
     â†“
åˆ›å»º passenger_profiles
â””â”€ user_id: 550e8400-...
     â†“
ç™»å½•æˆåŠŸ âœ…
     â†“
è·³è½¬åˆ°è§’è‰²é€‰æ‹©é¡µé¢
```

### ç”¨æˆ·å†æ¬¡ç™»å½•ï¼ˆè€ç”¨æˆ·ï¼‰

```
è¾“å…¥æ‰‹æœºå·: 13800138001
     â†“
è¾“å…¥éªŒè¯ç : 123456
     â†“
éªŒè¯éªŒè¯ç  âœ…
     â†“
ç™»å½• auth.users (é€šè¿‡é‚®ç®±ç™»å½•)
â””â”€ è¿”å›ç°æœ‰ Session
    â””â”€ id: 550e8400-...
     â†“
æŸ¥è¯¢ public.users (å·²å­˜åœ¨)
â””â”€ ç›´æ¥è¿”å›ç°æœ‰ç”¨æˆ· âœ…
     â†“
ç™»å½•æˆåŠŸ âœ…
     â†“
æ ¹æ®ç”¨æˆ·è§’è‰²è·³è½¬
```

---

## ğŸ”‘ å…³é”®å®ç°ç»†èŠ‚

### 1. Auth User ID çš„ä¸€è‡´æ€§

**éå¸¸é‡è¦**ï¼šç¡®ä¿ `auth.users.id` å’Œ `public.users.id` å®Œå…¨ä¸€è‡´

```swift
// âœ… æ­£ç¡®
let authUserId = session.user.id
let user = User(id: authUserId, ...)

// âŒ é”™è¯¯
let randomId = UUID()
let user = User(id: randomId, ...)  // è¿™ä¼šå¯¼è‡´æ— æ³•å…³è”ï¼
```

### 2. æŸ¥è¯¢ç”¨æˆ·çš„ä¸¤ç§æ–¹å¼

```swift
// æ–¹å¼ 1: é€šè¿‡ phone æŸ¥è¯¢ï¼ˆç”¨äºæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼‰
let user = try await userRepository.getUserByPhone(phone: phone)

// æ–¹å¼ 2: é€šè¿‡ auth.uid() æŸ¥è¯¢ï¼ˆç”¨äºè·å–å½“å‰ç”¨æˆ·ï¼‰
let user = try await userRepository.getCurrentUser()
// å†…éƒ¨å®ç°:
// SELECT * FROM users WHERE id = auth.uid()
```

### 3. RLS ç­–ç•¥é…ç½®

```sql
-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can view own profile"
ON public.users FOR SELECT
USING (auth.uid() = id);  -- â­ é€šè¿‡ auth.uid() å…³è”

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can update own profile"
ON public.users FOR UPDATE
USING (auth.uid() = id);
```

**å·¥ä½œåŸç†**:
1. ç”¨æˆ·ç™»å½•åï¼ŒSupabase ä¼šè®¾ç½® `auth.uid()`
2. `auth.uid()` è¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„ `auth.users.id`
3. RLS ç­–ç•¥ä½¿ç”¨ `auth.uid()` æ¥é™åˆ¶æ•°æ®è®¿é—®
4. åªèƒ½è®¿é—® `id = auth.uid()` çš„è®°å½•

---

## ğŸ†š å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

### å¯¹æ¯”è¡¨

| æ­¥éª¤ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|
| **å‘é€éªŒè¯ç ** | æ¨¡æ‹Ÿï¼ˆæ— æ“ä½œï¼‰ | `auth.signInWithOTP(phone)` |
| **éªŒè¯ç ** | å›ºå®š `123456` | éšæœºçœŸå®éªŒè¯ç  |
| **è®¤è¯æ–¹å¼** | é‚®ç®±ç™»å½•/æ³¨å†Œ | æ‰‹æœºå· OTP |
| **Auth è´¦å·** | `phone@dev.local` | çœŸå®æ‰‹æœºå· |
| **Session** | çœŸå® Session | çœŸå® Session |
| **public.users** | ä½¿ç”¨ REST API åˆ›å»º | ä½¿ç”¨ REST API åˆ›å»º |

### å…±åŒç‚¹

âœ… éƒ½åˆ›å»ºçœŸå®çš„ `auth.users` è®°å½•
âœ… éƒ½è·å¾—çœŸå®çš„ Auth Session
âœ… éƒ½ä½¿ç”¨ç›¸åŒçš„ `auth.user.id`
âœ… éƒ½åˆ›å»º `public.users` è®°å½•
âœ… ID å…³è”å…³ç³»å®Œå…¨ä¸€è‡´

---

## ğŸ“± æµ‹è¯•æ­¥éª¤

### é¦–æ¬¡ç™»å½•æµ‹è¯•

1. è¿è¡Œåº”ç”¨
2. è¾“å…¥æ‰‹æœºå·: `13800138001`
3. ç‚¹å‡»"è·å–éªŒè¯ç "
4. æŸ¥çœ‹æ§åˆ¶å°ï¼Œç¡®è®¤æ˜¾ç¤ºå›ºå®šéªŒè¯ç æç¤º
5. è¾“å…¥éªŒè¯ç : `123456`
6. ç‚¹å‡»"ç™»å½•"
7. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š

```
ğŸ” å¼€å§‹éªŒè¯ç™»å½•...
ğŸ“± æ‰‹æœºå·: 13800138001
ğŸ”¢ éªŒè¯ç : 123456
ğŸ”„ è°ƒç”¨ authService.verifyCode...
ğŸ” AuthService.verifyCode å¼€å§‹
ğŸ”§ å¼€å‘ç¯å¢ƒéªŒè¯æ¨¡å¼
âœ… éªŒè¯ç æ­£ç¡®
ğŸ” ä½¿ç”¨é‚®ç®±æ¨¡æ‹Ÿæ‰‹æœºå·è®¤è¯...
ğŸ”‘ å°è¯•ç™»å½•: 13800138001@dev.local
ğŸ“ è´¦å·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è´¦å·...
âœ… æ³¨å†ŒæˆåŠŸï¼ŒAuth User ID: 550e8400-...
ğŸ”„ è°ƒç”¨ signInOrRegister...
ğŸ” æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨...
â• ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·...
ğŸ’¾ æ’å…¥ç”¨æˆ·åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨ URLSessionï¼‰...
ğŸ“¡ HTTPçŠ¶æ€ç : 201
ğŸ“„ åŸå§‹å“åº”: [{"id":"550e8400-...","phone":"13800138001",...}]
âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ
âœ… Profileåˆ›å»ºå®Œæˆ
âœ… ç™»å½•æˆåŠŸ
```

8. åº”è¯¥è·³è½¬åˆ°è§’è‰²é€‰æ‹©é¡µé¢

### å†æ¬¡ç™»å½•æµ‹è¯•

1. é‡å¯åº”ç”¨
2. è¾“å…¥ç›¸åŒæ‰‹æœºå·: `13800138001`
3. è¾“å…¥éªŒè¯ç : `123456`
4. æŸ¥çœ‹æ§åˆ¶å°ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š

```
ğŸ”‘ å°è¯•ç™»å½•: 13800138001@dev.local
âœ… ç™»å½•æˆåŠŸï¼ŒAuth User ID: 550e8400-...
ğŸ” æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨...
âœ… æ‰¾åˆ°ç°æœ‰ç”¨æˆ·: 550e8400-...
âœ… ç™»å½•æˆåŠŸ
```

5. ç›´æ¥ç™»å½•æˆåŠŸï¼Œæ— éœ€åˆ›å»ºæ–°ç”¨æˆ·

---

## âœ… ä¼˜åŠ¿æ€»ç»“

### ä½¿ç”¨ Supabase Auth çš„å¥½å¤„

1. **å®‰å…¨æ€§** â­â­â­â­â­
   - å¯†ç è‡ªåŠ¨åŠ å¯†
   - Session è‡ªåŠ¨ç®¡ç†
   - JWT Token è‡ªåŠ¨å¤„ç†
   - é˜²æ­¢æš´åŠ›ç ´è§£

2. **åŠŸèƒ½å®Œæ•´** â­â­â­â­â­
   - é‚®ç®±éªŒè¯
   - æ‰‹æœºå·éªŒè¯
   - å¯†ç é‡ç½®
   - OAuth ç™»å½•ï¼ˆGoogle, Facebook ç­‰ï¼‰

3. **RLS é›†æˆ** â­â­â­â­â­
   - `auth.uid()` è‡ªåŠ¨å¯ç”¨
   - ç­–ç•¥ç®€å•æ¸…æ™°
   - æ•°æ®å®‰å…¨æœ‰ä¿éšœ

4. **å¼€å‘ä½“éªŒ** â­â­â­â­â­
   - å¼€å‘ç¯å¢ƒå‹å¥½ï¼ˆé‚®ç®±æ¨¡æ‹Ÿï¼‰
   - ç”Ÿäº§ç¯å¢ƒä¸€è‡´
   - æ˜“äºæµ‹è¯•å’Œè°ƒè¯•

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå¼€å‘é˜¶æ®µï¼‰

- âœ… ç»§ç»­ä½¿ç”¨å½“å‰æ–¹æ¡ˆï¼ˆé‚®ç®±æ¨¡æ‹Ÿ + REST APIï¼‰
- âœ… å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- âœ… æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ

### ä¸­æœŸï¼ˆæµ‹è¯•é˜¶æ®µï¼‰

- ğŸ”„ é…ç½®çœŸå®çš„çŸ­ä¿¡æœåŠ¡ï¼ˆTwilio, é˜¿é‡Œäº‘ç­‰ï¼‰
- ğŸ”„ æµ‹è¯•ç”Ÿäº§ç¯å¢ƒçš„ OTP æµç¨‹
- ğŸ”„ ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ˆå€’è®¡æ—¶ã€é‡å‘éªŒè¯ç ç­‰ï¼‰

### é•¿æœŸï¼ˆç”Ÿäº§é˜¶æ®µï¼‰

- ğŸš€ è€ƒè™‘åˆ‡æ¢å› Supabase Swift SDK
- ğŸš€ æ·»åŠ æ›´å¤šè®¤è¯æ–¹å¼ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ç­‰ï¼‰
- ğŸš€ å®ç° Session åˆ·æ–°æœºåˆ¶
- ğŸš€ æ·»åŠ è®¾å¤‡ç®¡ç†åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-27
**æœ€åæ›´æ–°**: 2025-12-27
**ä½œè€…**: Claude Code & AI Team
